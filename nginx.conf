# --- KHỐI HTTP (CỔNG 80) ---
# Bắt TẤT CẢ các domain và chuyển hướng sang HTTPS
# Đồng thời xử lý gia hạn Certbot
server {
    listen 80 default_server;
    listen [::]:80 default_server;

    # _ là wildcard, bắt tất cả domain
    server_name _;

    # 1. Xử lý Certbot (cho tất cả domain)
    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    # 2. Chuyển hướng tất cả sang HTTPS
    location / {
        return 301 https://$host$request_uri;
    }
}

# --- KHỐI HTTPS: engtastic.app (Learner - Next.js) ---
server {
    listen 443 ssl http2;
    server_name engtastic.app;

    # --- Cấu hình SSL (Dùng chung 1 file cert) ---
    ssl_certificate /etc/letsencrypt/live/engtastic.app/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/engtastic.app/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

    # --- Header chung cho proxy ---
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

location /socket.io/ {
        proxy_pass http://lms-backend-lms-be-1:5000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
    }

    # --- Định tuyến cho Next.js ---
    # 1. NextAuth
    location ^~ /api/auth/ {
        proxy_pass http://lms-frontend-learner-lms-learner-fe-1:4000;
    }

    # 2. Backend API (NestJS)
    location ^~ /api/ {
        proxy_pass http://lms-backend-lms-be-1:5000;
    }
    
    # --- AI Service (Dropout Predictor) ---
    location ^~ /ai/ {
        # Rewrite /ai/predict -> /predict
        rewrite ^/ai/(.*) /$1 break;
        proxy_pass http://dropout-predictor:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        # Tăng timeout cho batch processing
        proxy_read_timeout 300s;
        proxy_connect_timeout 300s;
        proxy_send_timeout 300s;
    }
    
    # 3. Mọi thứ khác (Trang Next.js)
    location / {
        proxy_pass http://lms-frontend-learner-lms-learner-fe-1:4000;
    }
}

# --- KHỐI HTTPS: teacher.engtastic.app (Teacher - Vite) ---
server {
    listen 443 ssl http2;
    server_name teacher.engtastic.app;

    # --- Cấu hình SSL (Dùng chung 1 file cert) ---
    ssl_certificate /etc/letsencrypt/live/engtastic.app/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/engtastic.app/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

    # --- Header chung cho proxy ---
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;


location /socket.io/ {
        proxy_pass http://lms-backend-lms-be-1:5000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
    }
    # --- Định tuyến cho Vite SPA ---
    # 1. Backend API (NestJS)
    location ^~ /api/ {
        proxy_pass http://lms-backend-lms-be-1:5000;
    }

    # 2. Mọi thứ khác (Trang Vite)
    location / {
        proxy_pass http://lms-teacher-fe:80;
    }
}

# --- KHỐI HTTPS: cms.engtastic.app (CMS - Vite) ---
server {
    listen 443 ssl http2;
    server_name cms.engtastic.app;

    # --- Cấu hình SSL (Dùng chung 1 file cert) ---
    ssl_certificate /etc/letsencrypt/live/engtastic.app/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/engtastic.app/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

    # --- Header chung cho proxy ---
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;


location /socket.io/ {
        proxy_pass http://lms-backend-lms-be-1:5000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
    }
    # --- Định tuyến cho Vite SPA ---
    # 1. Backend API (NestJS)
    location ^~ /api/ {
        proxy_pass http://lms-backend-lms-be-1:5000;
    }

    # 2. Mọi thứ khác (Trang Vite)
    location / {
        # Đảm bảo tên service này khớp với docker-compose.yml của CMS
        proxy_pass http://lms-cms-fe:80;
    }
}

# --- KHỐI HTTPS: toeic.engtastic.app (Toeic - Next.js) ---

server {
    listen 443 ssl http2;
    server_name toeic.engtastic.app;
    # --- Cấu hình SSL (Dùng chung cert engtastic.app) ---
    ssl_certificate /etc/letsencrypt/live/engtastic.app/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/engtastic.app/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

    # --- Header chung ---
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    # --- Socket.io ---
    location /socket.io/ {
        proxy_pass http://lms-backend-lms-be-1:5000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

    }
    # --- NextAuth (nếu dùng) ---
    location ^~ /api/auth/ {
        proxy_pass http://lms-toeic-fe:3002;

    }
    # --- Backend API ---
    location ^~ /api/ {
        proxy_pass http://lms-backend-lms-be-1:5000;

    }
    # --- FE Next.js ---
    location / {
        proxy_pass http://lms-toeic-fe:3002;
    }

}
